<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Stock System</title>

    <style>
        body {
            font-family: Arial;
            margin: 20px;
        }

        h2 {
            margin-bottom: 10px;
        }

        select, button, input {
            padding: 6px;
            margin: 5px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        th {
            background: #333;
            color: white;
        }

        tr:hover {
            background: #f1f7ff;
        }

        tr.selected {
            background: #cce5ff !important;
        }

        .top-bar {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>

<h2>üì¶ Stock Control</h2>

<div class="top-bar">

    <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏•‡∏±‡∏á -->
    <select onchange="changeWarehouse(this.value)">
        {% for w in warehouses %}
            <option value="{{w}}" {% if w == warehouse %}selected{% endif %}>
                {{w}}
            </option>
        {% endfor %}
    </select>

    <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏±‡∏á -->
    <input type="text" id="newWarehouse" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏±‡∏á">
    <button onclick="addWarehouse()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏±‡∏á</button>

    <!-- import -->
    <form action="/import/{{warehouse}}" method="post" enctype="multipart/form-data" style="display:inline;">
        <input type="file" name="file" required>
        <button type="submit">Import</button>
    </form>

    <!-- export -->
    <a href="/export/{{warehouse}}">
        <button>Export</button>
    </a>

    <!-- delete -->
    <button onclick="deleteSelected()">‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>

</div>

<!-- scan -->
<input type="text" id="barcode" placeholder="‡∏¢‡∏¥‡∏á barcode ‡πÅ‡∏•‡πâ‡∏ß enter" autofocus style="width:300px;">


<table id="productTable">
    <thead>
        <tr>
            <th>ID</th>
            <th>Location</th>
            <th>Model</th>
            <th>Description</th>
            <th>Inv.Qty</th>
            <th>Act.Qty</th>
        </tr>
    </thead>

    <tbody>
        {% for p in products %}
        <tr data-id="{{p[0]}}">
            <td>{{p[0]}}</td>
            <td>{{p[1]}}</td>
            <td>{{p[2]}}</td>
            <td>{{p[3]}}</td>
            <td>{{p[4]}}</td>
            <td>{{p[5]}}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>


<script>

document.addEventListener("DOMContentLoaded", function () {

    const table = document.getElementById("productTable");
    if (!table) return;

    const tbody = table.querySelector("tbody");
    if (!tbody) return;

    // ‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ñ‡∏ß (‡∏Å‡∏±‡∏ô crash ‡πÅ‡∏•‡πâ‡∏ß)
    tbody.querySelectorAll("tr").forEach(row => {
        row.addEventListener("click", function () {
            this.classList.toggle("selected");
        });
    });

    // ‚úÖ scan barcode
    const barcodeInput = document.getElementById("barcode");

    if (barcodeInput) {
        barcodeInput.addEventListener("keypress", function(e) {
            if (e.key === "Enter") {

                e.preventDefault();

                fetch("/scan", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: "barcode=" + this.value + "&warehouse={{warehouse}}"
                })
                .then(res => res.json())
                .then(data => {

                    if (data.status === "success") {
                        location.reload();
                    } else if (data.status === "duplicate") {
                        alert("‡∏ã‡πâ‡∏≥");
                    } else {
                        alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");
                    }

                });

                this.value = "";
            }
        });
    }

});


// ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏•‡∏±‡∏á
function changeWarehouse(w) {
    window.location = "/warehouse/" + w;
}


// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏±‡∏á
function addWarehouse() {

    const name = document.getElementById("newWarehouse").value;

    fetch("/add_warehouse", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({name: name})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
        }
    });

}


// ‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
function deleteSelected() {

    const selected = document.querySelectorAll("tr.selected");

    if (selected.length === 0) {
        alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å");
        return;
    }

    let ids = [];

    selected.forEach(row => {
        ids.push(row.getAttribute("data-id"));
    });

    fetch("/delete_selected", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ids: ids})
    })
    .then(res => res.text())
    .then(() => {
        location.reload();
    });

}

</script>

</body>
</html>